<script>
  const rowsPerPage = 10;
  let currentPage = 1;

  function paginate() {
    const rows = [...document.querySelectorAll("#appBody tr")];
    const totalPages = Math.ceil(rows.length / rowsPerPage);

    rows.forEach((row, index) => {
      row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage) ? "" : "none";
    });

    const pagination = document.getElementById("paginationControls");
    pagination.innerHTML = "";
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = (i === currentPage) ? "active" : "";
      btn.onclick = () => { currentPage = i; paginate(); };
      pagination.appendChild(btn);
    }
  }

  function filterTable() {
    const filter = document.getElementById("searchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#appBody tr");
    rows.forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
  }

  function toggleSelectAll(checkbox) {
    document.querySelectorAll(".selectRow").forEach(cb => cb.checked = checkbox.checked);
  }

  async function deleteSelected() {
    const confirmed = confirm("⚠️ Are you sure you want to permanently delete selected applications?");
    if (!confirmed) return;

    const selectedEmails = Array.from(document.querySelectorAll(".selectRow:checked"))
      .map(cb => cb.closest("tr").children[3].innerText.trim());

    if (selectedEmails.length === 0) {
      alert("No rows selected.");
      return;
    }

    try {
      const res = await fetch("/delete_applications", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ emails: selectedEmails })
      });

      const data = await res.json();

      if (res.ok) {
        alert(`✅ ${data.deleted} application(s) permanently deleted.`);
        location.reload();
      } else {
        alert("❌ Deletion failed: " + data.message);
      }

    } catch (err) {
      console.error("Delete failed", err);
      alert("❌ Server error during deletion.");
    }
  }

  function exportCSV() {
    const rows = Array.from(document.querySelectorAll("#appTable tr"));
    const csv = rows.map(row =>
      Array.from(row.cells)
        .map(cell => `"${cell.innerText.trim().replace(/"/g, '""')}"`)
        .join(",")
    ).join("\n");

    const blob = new Blob([csv], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "applications.csv";
    link.click();
  }

  function showImage(src) {
    document.getElementById("modalImg").src = src;
    document.getElementById("imageModal").classList.add("show");
  }

  window.onload = paginate;
</script>