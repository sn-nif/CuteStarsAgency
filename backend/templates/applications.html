<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Cute Stars</title>
  <style>
    body{margin:0;font-family:Arial, sans-serif;display:flex;height:100vh;background:#111;color:#f8f8f8}
    .sidebar{width:220px;background:#1a1a1a;display:flex;flex-direction:column;padding:20px}
    .sidebar h2{color:gold;font-size:20px;margin-bottom:30px}
    .sidebar button{background:none;border:none;color:#fff;font-size:16px;text-align:left;padding:10px 0;cursor:pointer;transition:.3s}
    .sidebar button:hover,.sidebar button.active{color:gold}
    .main-content{flex-grow:1;padding:20px;overflow-y:auto}
    h1{color:gold;text-align:center}
    table{width:100%;border-collapse:collapse;margin-top:20px;background:#222}
    th,td{border:1px solid #333;padding:8px;text-align:left}
    th{background:#333;color:gold}
    td img{width:50px;height:50px;object-fit:cover;cursor:pointer}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,.8);justify-content:center;align-items:center}
    .modal img{max-width:90vw;max-height:90vh}
    .controls{margin:20px 0}
    .controls input,.controls select{padding:10px;border-radius:4px;border:none;margin-right:10px}
    .controls button{padding:10px 15px;background:gold;border:none;cursor:pointer;color:black;font-weight:bold}
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Admin Panel</h2>
    <button id="applicationsTab" class="active">üìÑ Applications</button>
    <button id="settingsTab">‚öôÔ∏è Settings</button>
  </div>

  <div class="main-content">
    <!-- Applications -->
    <div id="applicationsSection">
      <h1>Applications</h1>
      <div class="controls">
        <input type="text" id="searchBox" placeholder="Search by name, email, phone..." />
        <select id="adminSelect"><option value="">Select Admin</option></select>
        <button onclick="sendToTelegram()">Send to Telegram</button>
        <button onclick="exportToCSV()">Export CSV</button>
        <button onclick="deleteSelected()">Delete Selected</button>
      </div>
      <table id="appsTable">
        <thead>
          <tr>
            <th><input type="checkbox" onclick="toggleAll(this)" /></th>
            <th>Name</th><th>Age</th><th>Email</th><th>Phone</th>
            <th>Nationality</th><th>ip City</th><th>ip Region</th>
            <th>ip Country</th><th>Browser Location</th><th>Photos</th>
          </tr>
        </thead>
        <tbody id="appsBody"></tbody>
      </table>
    </div>

    <!-- Settings -->
    <div id="settingsSection" style="display:none;">
      <h1>Settings</h1>

      <h2 style="color: gold;">üîê Change Admin Username & Password</h2>
      <form id="changeAdminForm">
        <input type="text" id="newUsername" placeholder="New Username" required />
        <input type="password" id="newPassword" placeholder="New Password" required />
        <button type="submit">Update Admin</button>
      </form>

      <hr style="margin: 30px 0; border: 1px solid #333;" />

      <h2 style="color: gold;">üë§ Add or Edit User</h2>
      <form id="addUserForm">
        <input type="text" id="newUser" placeholder="Username" required />
        <input type="password" id="newUserPassword" placeholder="Password (leave blank to keep)" />
        <input type="text" id="newUserTelegram" placeholder="Telegram Username or ID" />
        <div>
          <label><input type="checkbox" name="perm" value="view" /> View</label>
          <label><input type="checkbox" name="perm" value="edit" /> Edit</label>
          <label><input type="checkbox" name="perm" value="delete" /> Delete</label>
        </div>
        <button type="submit">Save User</button>
        <button type="button" onclick="clearUserForm()">Clear</button>
      </form>

      <hr style="margin: 30px 0; border: 1px solid #333;" />
      <h2 style="color: gold;">üë• Users</h2>
      <div id="userList"><p>Loading...</p></div>

      <!-- üìö Bot Knowledge (Upload PDF) -->
      <hr style="margin: 30px 0; border: 1px solid #333;" />
      <h2 style="color: gold;">üìö Bot Knowledge (Upload PDF)</h2>
      <form id="pdfForm" enctype="multipart/form-data" style="margin-top:10px;">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <label style="min-width:120px;">Language</label>
          <select id="pdfLang" name="lang" required style="padding:10px; border-radius:4px; border:none;">
            <option value="English">English</option>
            <option value="Spanish">Spanish</option>
            <option value="Portuguese">Portuguese</option>
            <option value="Russian">Russian</option>
            <option value="Serbian">Serbian</option>
          </select>
        </div>
        <div style="margin-top:10px;">
          <input id="pdfFile" type="file" name="file" accept="application/pdf" required />
        </div>
        <button type="submit" style="margin-top:12px;">Upload & Index PDF</button>
        <div id="pdfMsg" style="margin-top:8px; color:#bbb;"></div>
      </form>
    </div>
  </div>

  <div class="modal" id="imageModal" onclick="this.style.display='none'">
    <img id="modalImage" src="" />
  </div>

  <script>
    // Tabs
    const applicationsTab = document.getElementById("applicationsTab");
    const settingsTab = document.getElementById("settingsTab");
    const applicationsSection = document.getElementById("applicationsSection");
    const settingsSection = document.getElementById("settingsSection");
    applicationsTab.onclick = () => { applicationsSection.style.display="block"; settingsSection.style.display="none";
      applicationsTab.classList.add("active"); settingsTab.classList.remove("active"); };
    settingsTab.onclick = () => { applicationsSection.style.display="none"; settingsSection.style.display="block";
      settingsTab.classList.add("active"); applicationsTab.classList.remove("active"); loadUsers(); };

    // Apps table helpers
    function toggleAll(master){ document.querySelectorAll("#appsBody input[type='checkbox']").forEach(cb=>cb.checked=master.checked); }
    function deleteSelected(){
      const selected = Array.from(document.querySelectorAll("#appsBody input[type='checkbox']:checked")).map(cb=>cb.dataset.email);
      if(!selected.length) return alert("Select at least one.");
      fetch("/delete_applications",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({emails:selected})})
        .then(r=>r.json()).then(d=>{ alert("Deleted "+d.deleted+" applications."); location.reload(); });
    }
    function exportToCSV(){
      const rows=[["Name","Age","Email","Phone","Country"]];
      document.querySelectorAll("#appsBody tr").forEach(tr=>{
        const cols=Array.from(tr.querySelectorAll("td")).map(td=>td.innerText); rows.push(cols.slice(1,6));
      });
      const csv=rows.map(r=>r.join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="applications.csv"; a.click(); URL.revokeObjectURL(url);
    }
    async function loadApplications() {
      try {
        const res = await fetch("/api/applications", { credentials: "include" });
        if (!res.ok) {
          throw new Error("Failed to load applications");
        }
        const data = await res.json();
        const body = document.getElementById("appsBody");
        body.innerHTML = "";
    
        data.forEach(app => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><input type="checkbox" data-email="${app.email}" /></td>
            <td>${app.name || "‚Äî"}</td>
            <td>${app.age || "‚Äî"}</td>
            <td>${app.email || "‚Äî"}</td>
            <td>+${app.contact || "‚Äî"}</td>
            <td>${app.country_flag || ""} ${app.country || "‚Äî"}</td>
            <td>${app.ip_city || "‚Äî"}</td>
            <td>${app.ip_region || "‚Äî"}</td>
            <td>${app.ip_country || "‚Äî"}</td>
            <td>
              ${app.geo_latitude && app.geo_longitude
                ? `<a href="https://maps.google.com/?q=${app.geo_latitude},${app.geo_longitude}" target="_blank">üìç View</a><br><small>${app.geo_accuracy || "?"}m</small>`
                : "‚Äî"}
            </td>
            <td>${(app.photos || []).map(url => `<img src="${url}" onclick="viewImage('${url}')" />`).join("")}</td>
          `;
          body.appendChild(row);
        });
  } catch (e) {
    alert(e.message);
  }
}

    async function loadAdminDropdown(){
      const res=await fetch("/api/users"); const users=await res.json();
      const dd=document.getElementById("adminSelect"); dd.innerHTML='<option value="">Select Admin</option>';
      users.forEach(u=>{ if(u.telegram) dd.innerHTML+=`<option value="${u.telegram}">${u.username}</option>`; });
    }
    async function sendToTelegram(){
      const tg=document.getElementById("adminSelect").value; if(!tg) return alert("Please select an admin.");
      const emails=Array.from(document.querySelectorAll("#appsBody input[type='checkbox']:checked")).map(cb=>cb.dataset.email);
      if(!emails.length) return alert("Select at least one application.");
      const res=await fetch("/send_to_admin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({telegram_id:tg,emails})});
      const r=await res.json(); alert(r.status==="ok"?"Sent successfully":"Error: "+r.message);
    }
    function viewImage(url){ const m=document.getElementById("imageModal"); const i=document.getElementById("modalImage"); i.src=url; m.style.display="flex"; }

    // Users CRUD
    let editingUserId=null;
    document.getElementById("addUserForm").onsubmit=async(e)=>{
      e.preventDefault();
      const username=document.getElementById("newUser").value;
      const password=document.getElementById("newUserPassword").value;
      const telegram=document.getElementById("newUserTelegram").value;
      const permissions=Array.from(document.querySelectorAll("input[name='perm']:checked")).map(cb=>cb.value);
      const payload={username,telegram,permissions}; if(password) payload.password=password;
      const url=editingUserId?`/api/edit-user/${editingUserId}`:"/api/add-user"; const method=editingUserId?"PUT":"POST";
      const res=await fetch(url,{method,headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      const d=await res.json(); alert(d.status||d.error); clearUserForm(); loadUsers();
    };
    function clearUserForm(){ editingUserId=null;
      document.getElementById("newUser").value=""; document.getElementById("newUserPassword").value="";
      document.getElementById("newUserTelegram").value=""; document.querySelectorAll("input[name='perm']").forEach(cb=>cb.checked=false);
    }
    function loadUsers(){
      fetch("/api/users").then(r=>r.json()).then(users=>{
        const c=document.getElementById("userList");
        if(!users.length){ c.innerHTML="<p>No users found.</p>"; return; }
        c.innerHTML=`<table style="width:100%; margin-top:20px;">
          <tr><th style="color:gold;">Username</th><th style="color:gold;">Telegram</th><th style="color:gold;">Permissions</th><th style="color:gold;">Actions</th></tr>
          ${users.map(u=>`
            <tr>
              <td>${u.username}</td><td>${u.telegram || "‚Äî"}</td><td>${u.permissions.join(", ")}</td>
              <td><button onclick='editUser(${JSON.stringify(u)})'>Edit</button>
                  <button onclick='deleteUser("${u.id}")'>Delete</button></td>
            </tr>`).join("")}
        </table>`;
      });
    }
    function editUser(u){
      editingUserId=u.id;
      document.getElementById("newUser").value=u.username;
      document.getElementById("newUserPassword").value="";
      document.getElementById("newUserTelegram").value=u.telegram||"";
      document.querySelectorAll("input[name='perm']").forEach(cb=>cb.checked=u.permissions.includes(cb.value));
    }
    function deleteUser(id){
      if(!confirm("Are you sure you want to delete this user?")) return;
      fetch(`/api/delete-user/${id}`,{method:"DELETE"}).then(r=>r.json()).then(d=>{ alert(d.status||d.error); loadUsers(); });
    }
    document.getElementById("changeAdminForm").onsubmit=e=>{
      e.preventDefault();
      const username=document.getElementById("newUsername").value;
      const password=document.getElementById("newPassword").value;
      fetch("/api/update-admin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,password})})
        .then(r=>r.json()).then(d=>alert(d.status||d.error));
    };

    // PDF upload -> /admin/upload-pdf
    const pdfForm=document.getElementById("pdfForm");
    if(pdfForm){
      pdfForm.addEventListener("submit",async(e)=>{
        e.preventDefault();
        const msg=document.getElementById("pdfMsg"); msg.style.color="#bbb"; msg.textContent="Uploading & indexing‚Ä¶";
        const data=new FormData(); const file=document.getElementById("pdfFile").files[0]; const lang=document.getElementById("pdfLang").value;
        if(!file){ msg.textContent="Please choose a PDF."; return; }
        data.append("file",file); data.append("lang",lang);
        try{
          const res=await fetch("/admin/upload-pdf",{method:"POST",body:data,credentials:"include"});
          const json=await res.json(); if(!res.ok) throw new Error(json.error||"Upload failed");
          msg.style.color="#9BE37A"; msg.textContent=`‚úÖ Indexed ${json.chunks} chunks for ${json.lang}.`; pdfForm.reset();
        }catch(err){ msg.style.color="#ff6b6b"; msg.textContent="‚ùå "+err.message; }
      });
    }

    // initial draws
    loadApplications();
    loadAdminDropdown();
  </script>

  
</body>
</html>