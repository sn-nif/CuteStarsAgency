<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Cute Stars</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background-color: #111;
      color: #f8f8f8;
    }

    .sidebar {
      width: 220px;
      background-color: #1a1a1a;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    .sidebar h2 {
      color: gold;
      font-size: 20px;
      margin-bottom: 30px;
    }

    .sidebar button {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      text-align: left;
      padding: 10px 0;
      cursor: pointer;
      transition: 0.3s;
    }

    .sidebar button:hover,
    .sidebar button.active {
      color: gold;
    }

    .main-content {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
    }

    h1 {
      color: gold;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #222;
    }

    th, td {
      border: 1px solid #333;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #333;
      color: gold;
    }

    td img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      cursor: pointer;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }

    .modal img {
      max-width: 90vw;
      max-height: 90vh;
    }

    .controls {
      margin: 20px 0;
    }

    .controls input, .controls select {
      padding: 10px;
      border-radius: 4px;
      border: none;
      margin-right: 10px;
    }

    .controls button {
      padding: 10px 15px;
      background-color: gold;
      border: none;
      cursor: pointer;
      color: black;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Admin Panel</h2>
    <button id="applicationsTab" class="active">üìÑ Applications</button>
    <button id="settingsTab">‚öôÔ∏è Settings</button>
  </div>

  <div class="main-content">
    <div id="applicationsSection">
      <h1>Applications</h1>
      <div class="controls">
        <input type="text" id="searchBox" placeholder="Search by name, email, phone..." />
        <select id="adminSelect">
          <option value="">Select Admin</option>
        </select>
        <button onclick="sendToTelegram()">Send to Telegram</button>
        <button onclick="exportToCSV()">Export CSV</button>
        <button onclick="deleteSelected()">Delete Selected</button>
      </div>
      <table id="appsTable">
        <thead>
          <tr>
            <th><input type="checkbox" onclick="toggleAll(this)" /></th>
            <th>Name</th>
            <th>Age</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Nationality</th>
            <th>ip City</th>
            <th>ip Region</th>
            <th>ip Country</th>
            <th>Browser Location</th>
            <th>Photos</th>
          </tr>
        </thead>
        <tbody id="appsBody"></tbody>
      </table>
    </div>

    <div id="settingsSection" style="display: none;">
      <h1>Settings</h1>
      <h2 style="color: gold;">üîê Change Admin Username & Password</h2>
      <form id="changeAdminForm">
        <input type="text" id="newUsername" placeholder="New Username" required />
        <input type="password" id="newPassword" placeholder="New Password" required />
        <button type="submit">Update Admin</button>
      </form>

      <hr style="margin: 30px 0; border: 1px solid #333;" />

      <h2 style="color: gold;">üë§ Add or Edit User</h2>
      <form id="addUserForm">
        <input type="text" id="newUser" placeholder="Username" required />
        <input type="password" id="newUserPassword" placeholder="Password (leave blank to keep)" />
        <input type="text" id="newUserTelegram" placeholder="Telegram Username or ID" />
        <div>
          <label><input type="checkbox" name="perm" value="view" /> View</label>
          <label><input type="checkbox" name="perm" value="edit" /> Edit</label>
          <label><input type="checkbox" name="perm" value="delete" /> Delete</label>
        </div>
        <button type="submit">Save User</button>
        <button type="button" onclick="clearUserForm()">Clear</button>
      </form>

      <hr style="margin: 30px 0; border: 1px solid #333;" />
      <h2 style="color: gold;">üë• Users</h2>
      <div id="userList"><p>Loading...</p></div>
    </div>
  </div>

  <div class="modal" id="imageModal" onclick="this.style.display='none'">
    <img id="modalImage" src="" />
  </div>

  <script>
    const applicationsTab = document.getElementById("applicationsTab");
    const settingsTab = document.getElementById("settingsTab");
    const applicationsSection = document.getElementById("applicationsSection");
    const settingsSection = document.getElementById("settingsSection");

    applicationsTab.onclick = () => {
      applicationsSection.style.display = "block";
      settingsSection.style.display = "none";
      applicationsTab.classList.add("active");
      settingsTab.classList.remove("active");
    };

    settingsTab.onclick = () => {
      applicationsSection.style.display = "none";
      settingsSection.style.display = "block";
      settingsTab.classList.add("active");
      applicationsTab.classList.remove("active");
      loadUsers();
    };

    function toggleAll(master) {
      document.querySelectorAll("#appsBody input[type='checkbox']").forEach(cb => {
        cb.checked = master.checked;
      });
    }

    function deleteSelected() {
      const selected = Array.from(document.querySelectorAll("#appsBody input[type='checkbox']:checked"))
        .map(cb => cb.dataset.email);
      if (!selected.length) return alert("Select at least one.");
      fetch("/delete_applications", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ emails: selected })
      }).then(res => res.json()).then(data => {
        alert("Deleted " + data.deleted + " applications.");
        location.reload();
      });
    }

    function exportToCSV() {
      const rows = [["Name", "Age", "Email", "Phone", "Country"]];
      document.querySelectorAll("#appsBody tr").forEach(tr => {
        const cols = Array.from(tr.querySelectorAll("td")).map(td => td.innerText);
        rows.push(cols.slice(1, 6));
      });
      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "applications.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function loadApplications() {
      fetch("/applications")
        .then(res => res.text())
        .then(html => {
          const data = JSON.parse(document.body.querySelector("script[type='application/json']").textContent);
          const body = document.getElementById("appsBody");
          body.innerHTML = "";
          data.forEach(app => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td><input type="checkbox" data-email="${app.email}" /></td>
              <td>${app.name}</td>
              <td>${app.age}</td>
              <td>${app.email}</td>
              <td>+${app.contact}</td>
              <td>${app.country_flag || ""} ${app.country}</td>
              <td>${app.ip_city || "‚Äî"}</td>
              <td>${app.ip_region || "‚Äî"}</td>
              <td>${app.ip_country || "‚Äî"}</td>
              <td>
                ${app.geo_latitude && app.geo_longitude 
                  ? `<a href="https://maps.google.com/?q=${app.geo_latitude},${app.geo_longitude}" target="_blank">üìç View</a><br><small>${app.geo_accuracy || "?"}m</small>`
                      : "‚Äî"}
              </td>
              <td>${app.photos.map(url => `<img src="${url}" onclick="viewImage('${url}')" />`).join("")}</td>
            `;
            body.appendChild(row);
          });
        });
    }

    async function loadAdminDropdown() {
      const res = await fetch("/api/users");
      const users = await res.json();
      const dropdown = document.getElementById("adminSelect");
      dropdown.innerHTML = '<option value="">Select Admin</option>';
      users.forEach(user => {
        if (user.telegram) {
          dropdown.innerHTML += `<option value="${user.telegram}">${user.username}</option>`;
        }
      });
    }

    async function sendToTelegram() {
      const selectedTelegram = document.getElementById("adminSelect").value;
      if (!selectedTelegram) return alert("Please select an admin.");

      const selectedEmails = Array.from(document.querySelectorAll("#appsBody input[type='checkbox']:checked"))
        .map(cb => cb.dataset.email);

      if (!selectedEmails.length) return alert("Select at least one application.");

      const res = await fetch("/send_to_admin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telegram_id: selectedTelegram, emails: selectedEmails })
      });

      const result = await res.json();
      alert(result.status === "ok" ? "Sent successfully" : "Error: " + result.message);
    }

    function viewImage(url) {
      const modal = document.getElementById("imageModal");
      const img = document.getElementById("modalImage");
      img.src = url;
      modal.style.display = "flex";
    }

    let editingUserId = null;

    document.getElementById("addUserForm").onsubmit = async (e) => {
      e.preventDefault();
      const username = document.getElementById("newUser").value;
      const password = document.getElementById("newUserPassword").value;
      const telegram = document.getElementById("newUserTelegram").value;
      const permissions = Array.from(document.querySelectorAll("input[name='perm']:checked"))
        .map(cb => cb.value);

      const payload = { username, telegram, permissions };
      if (password) payload.password = password;

      const url = editingUserId ? `/api/edit-user/${editingUserId}` : "/api/add-user";
      const method = editingUserId ? "PUT" : "POST";

      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      alert(data.status || data.error);
      clearUserForm();
      loadUsers();
    };

    function clearUserForm() {
      editingUserId = null;
      document.getElementById("newUser").value = "";
      document.getElementById("newUserPassword").value = "";
      document.getElementById("newUserTelegram").value = "";
      document.querySelectorAll("input[name='perm']").forEach(cb => cb.checked = false);
    }

    function loadUsers() {
      fetch("/api/users")
        .then(res => res.json())
        .then(users => {
          const container = document.getElementById("userList");
          if (!users.length) {
            container.innerHTML = "<p>No users found.</p>";
            return;
          }
          container.innerHTML = `<table style="width:100%; margin-top:20px;">
            <tr><th style="color:gold;">Username</th><th style="color:gold;">Telegram</th><th style="color:gold;">Permissions</th><th style="color:gold;">Actions</th></tr>
            ${users.map(user => `
              <tr>
                <td>${user.username}</td>
                <td>${user.telegram || "‚Äî"}</td>
                <td>${user.permissions.join(", ")}</td>
                <td>
                  <button onclick='editUser(${JSON.stringify(user)})'>Edit</button>
                  <button onclick='deleteUser("${user.id}")'>Delete</button>
                </td>
              </tr>`).join("")}
          </table>`;
        });
    }

    function editUser(user) {
      editingUserId = user.id;
      document.getElementById("newUser").value = user.username;
      document.getElementById("newUserPassword").value = "";
      document.getElementById("newUserTelegram").value = user.telegram || "";
      document.querySelectorAll("input[name='perm']").forEach(cb => {
        cb.checked = user.permissions.includes(cb.value);
      });
    }

    function deleteUser(id) {
      if (!confirm("Are you sure you want to delete this user?")) return;
      fetch(`/api/delete-user/${id}`, { method: "DELETE" })
        .then(res => res.json())
        .then(data => {
          alert(data.status || data.error);
          loadUsers();
        });
    }

    document.getElementById("changeAdminForm").onsubmit = e => {
      e.preventDefault();
      const username = document.getElementById("newUsername").value;
      const password = document.getElementById("newPassword").value;
      fetch("/api/update-admin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      }).then(res => res.json()).then(data => {
        alert(data.status || data.error);
      });
    };

    loadApplications();
    loadAdminDropdown();
  </script>

  <script type="application/json">
    {{ apps|tojson }}
  </script>
</body>
</html>
